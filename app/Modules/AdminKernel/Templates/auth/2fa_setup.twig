{% extends "layout.twig" %}

{% block title %}2FA Setup{% endblock %}

{% block content %}
    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 px-4 py-12">
        <div class="max-w-2xl w-full">
            <!-- Logo Section -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-white">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Setup Two-Factor Authentication</h1>
                <p class="text-gray-600 mt-2">Secure your account with an extra layer of protection</p>
            </div>

            <!-- Main Card -->
            <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                <div class="px-8 py-6">
                    {% if error %}
                        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                            </svg>
                            <p class="text-sm text-red-800">{{ error }}</p>
                        </div>
                    {% endif %}

                    <!-- Instructions -->
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
                            </svg>
                            <div class="text-sm text-blue-800">
                                <p class="font-medium mb-1">Follow these steps to enable 2FA:</p>
                                <ol class="list-decimal list-inside space-y-1 text-blue-700">
                                    <li>Download an authenticator app (Google Authenticator, Authy, etc.)</li>
                                    <li>Scan the QR code or enter the secret key manually</li>
                                    <li>Enter the 6-digit code from your app to verify</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code and Secret -->
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <!-- QR Code Section -->
                        <div class="text-center">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z" />
                                </svg>
                                Scan QR Code
                            </h3>
                            <div class="inline-block p-4 bg-white border-2 border-gray-300 rounded-lg shadow-sm">
                                <img
                                        src="{{ qr_image_url }}"
                                        alt="TOTP QR Code"
                                        class="w-48 h-48"
                                >
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Use your authenticator app to scan</p>
                        </div>

                        <!-- Manual Secret Section -->
                        <div class="flex flex-col justify-center">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" />
                                </svg>
                                Manual Entry
                            </h3>
                            <p class="text-sm text-gray-600 mb-3">Can't scan? Enter this secret key manually:</p>
                            <div class="relative">
                                <div class="bg-gray-50 border border-gray-300 rounded-lg p-4 font-mono text-sm break-all select-all" id="secret-text">
                                    {{ secret }}
                                </div>
                                <button
                                        type="button"
                                        id="copy-secret-btn"
                                        class="absolute top-2 right-2 p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition-all"
                                        title="Copy to clipboard"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" />
                                    </svg>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Keep this secret safe and private</p>
                        </div>
                    </div>

                    <!-- Verification Form -->
                    <div class="border-t border-gray-200 pt-6">
                        <form method="POST" action="/2fa/setup" class="space-y-5">
                            <div>
                                <label for="otp" class="block text-sm font-medium text-gray-700 mb-2">
                                    Enter Verification Code
                                </label>
                                <input
                                        type="text"
                                        id="otp"
                                        name="otp"
                                        required
                                        inputmode="numeric"
                                        pattern="[0-9]{6}"
                                        autocomplete="one-time-code"
                                        maxlength="6"
                                        class="w-full px-4 py-3 text-center text-2xl font-mono tracking-widest border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                        placeholder="000000"
                                        autofocus
                                >
                                <p class="mt-2 text-xs text-gray-500">Enter the 6-digit code from your authenticator app</p>
                            </div>

                            <button
                                    type="submit"
                                    class="w-full px-4 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 shadow-sm hover:shadow-md flex items-center justify-center gap-2"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                </svg>
                                <span>Verify & Enable 2FA</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Footer Info -->
                <div class="px-8 py-4 bg-gray-50 border-t border-gray-200">
                    <div class="flex items-start gap-3 text-sm text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                        </svg>
                        <div>
                            <p class="font-medium text-gray-700 mb-1">Important:</p>
                            <ul class="space-y-1 text-xs">
                                <li>• Save your recovery codes in a safe place</li>
                                <li>• Don't share your secret key with anyone</li>
                                <li>• Keep your authenticator app backed up</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Text -->
            <div class="mt-6 text-center text-sm text-gray-600">
                <p>Need help setting up 2FA? <a href="/support" class="text-blue-600 hover:text-blue-700 font-medium">Contact Support</a></p>
            </div>
        </div>
    </div>

    <style>
        /* Auto-focus animation */
        @keyframes pulse-border {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5);
            }
            50% {
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            }
        }

        #otp:focus {
            animation: pulse-border 2s ease-in-out infinite;
        }

        /* Copy notification */
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(-10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        .copy-notification {
            animation: fade-in-out 2s ease-in-out;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const otpInput = document.getElementById('otp');
            const copyBtn = document.getElementById('copy-secret-btn');
            const secretText = document.getElementById('secret-text');

            // Auto-submit when 6 digits entered
            otpInput.addEventListener('input', function(e) {
                // Only allow numbers
                this.value = this.value.replace(/[^0-9]/g, '');

                // Auto-submit when 6 digits
                if (this.value.length === 6) {
                    this.form.submit();
                }
            });

            // Paste handling
            otpInput.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                const cleanedText = pastedText.replace(/[^0-9]/g, '').substring(0, 6);
                this.value = cleanedText;

                if (cleanedText.length === 6) {
                    this.form.submit();
                }
            });

            // Copy secret to clipboard
            copyBtn.addEventListener('click', function() {
                const secret = secretText.textContent.trim();

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(secret).then(() => {
                        showCopyNotification();
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        fallbackCopy(secret);
                    });
                } else {
                    fallbackCopy(secret);
                }
            });

            function fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();

                try {
                    document.execCommand('copy');
                    showCopyNotification();
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                }

                document.body.removeChild(textarea);
            }

            function showCopyNotification() {
                // Change button icon temporarily
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
        `;
                copyBtn.classList.add('text-green-600');

                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.classList.remove('text-green-600');
                }, 2000);

                // Show notification
                const notification = document.createElement('div');
                notification.textContent = 'Secret copied!';
                notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg text-sm font-medium copy-notification z-50';
                document.body.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 2000);
            }
        });
    </script>
{% endblock %}