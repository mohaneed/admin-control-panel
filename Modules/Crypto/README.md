# Cryptography Module

## 1. Overview

This module is a **Security-First cryptographic system** providing a set of strict, isolated, and frozen cryptographic primitives. It is designed to be extracted as a standalone library, independent of any specific application framework.

The system enforces a **strict separation of concerns** between key lifecycle management, key derivation, reversible encryption, and password hashing. It prioritizes **safety, deterministic behavior, and fail-closed security** over developer convenience.

All cryptographic primitives within this module are **frozen**, meaning their core logic, algorithms, and security boundaries are immutable. Any significant change to these primitives requires a formal architectural review.

## 2. Module Breakdown

The cryptographic system is composed of five distinct, decoupled modules:

### 1. Password Module (`Password/`)
- **Purpose:** Secure, irreversible password hashing and verification.
- **What it DOES:** Implements a strict pipeline of **HMAC-SHA256 (Pepper) → Argon2id**. It handles hashing, verification, and rehash checks.
- **What it DOES NOT do:** It does not manage the storage of hashes or the retrieval of the pepper secret.
- **Security Boundary:** It operates in total isolation from encryption keys. It relies on an injected `PasswordPepperProviderInterface`.

### 2. KeyRotation Module (`KeyRotation/`)
- **Purpose:** Management of cryptographic key lifecycles and rotation policies.
- **What it DOES:** Enforces strict invariants: exactly one **ACTIVE** key at any time. It manages key states (Active, Inactive, Retired) to support seamless key rotation without downtime.
- **What it DOES NOT do:** It does not perform any encryption or decryption. It does not load keys from storage (DB, Vault, Env).
- **Security Boundary:** It is the sole authority on *which* key is valid for new encryption operations.

### 3. HKDF Module (`HKDF/`)
- **Purpose:** Key Derivation Function (RFC 5869) for domain separation.
- **What it DOES:** Derives cryptographically independent keys from a root key based on explicit, versioned context strings (e.g., `notification:email:v1`).
- **What it DOES NOT do:** It does not generate root secrets or perform encryption.
- **Security Boundary:** Ensures that a compromise of one domain's key (e.g., email notifications) cannot be used to decrypt data from another domain (e.g., authentication tokens).

### 4. Reversible Module (`Reversible/`)
- **Purpose:** Symmetric encryption and decryption (AES-256-GCM).
- **What it DOES:** Provides a strict interface for encrypting data and decrypting it back to its original form.
- **What it DOES NOT do:** It does not manage keys. It relies on keys provided by the caller (typically via KeyRotation or HKDF).
- **Security Boundary:** It is fail-closed. It will throw exceptions for any failure (integrity check, missing key, invalid algorithm). It strictly forbids weak algorithms like ECB.

### 5. DX Module (`DX/`)
- **Purpose:** Developer Experience and Orchestration.
- **What it DOES:** Acts as a glue layer to wire the strict primitives into usable pipelines. It provides a `CryptoProvider` facade for consumers.
- **What it DOES NOT do:** It implements **no** cryptographic logic. It is purely for orchestration.
- **Security Boundary:** It is an optional convenience layer. The security guarantees reside in the underlying modules.

## 3. Architectural Flow

The module supports three primary security pipelines:

### A. Password Hashing Pipeline
Used for authenticating users.
`Input Password` → `HMAC-SHA256 (Global Pepper)` → `Argon2id (Salted)` → `Hash`

### B. Context-Based Encryption Pipeline (Recommended)
Used for protecting sensitive data with domain separation.
`Root Keys (KeyRotation)` → `HKDF (Context String)` → `Derived Keys` → `AES-256-GCM (Reversible)`

### C. Direct Encryption Pipeline (Advanced)
Used strictly for internal system secrets where domain separation is not applicable.
`Root Keys (KeyRotation)` → `AES-256-GCM (Reversible)`

**Key Hierarchy:**
- **Root Keys:** Managed by `KeyRotation`. Never used directly for domain data in the standard pipeline.
- **Derived Keys:** Ephemeral keys generated by `HKDF`. Used for actual encryption.
- **Password Secrets:** The "Pepper" is completely isolated from encryption keys.

## 4. Design Principles

- **Fail-Closed Behavior:** All modules throw exceptions on error. There are no silent failures, no "false" returns, and no fallbacks to insecure defaults.
- **Explicit Versioning:** Contexts and keys are explicitly versioned. Implicit defaults are forbidden.
- **Domain Separation:** Different types of data must use different cryptographic contexts.
- **Key Rotation Safety:** The system is designed to support key rotation natively. Old keys remain available for decryption (until revoked), while new data is always encrypted with the active key.
- **No Implicit Defaults:** Algorithms, keys, and contexts must be explicitly defined.
- **No Hidden State:** The modules are stateless. They do not hold state between requests and do not cache secrets internally.

## 5. What This Module Is NOT

- **Not a Framework:** It does not depend on Laravel, Symfony, or any other framework.
- **Not a Key Management System (KMS):** It does not store keys. It requires a provider to inject keys from an external source (Env, Vault, DB).
- **Not a Secrets Loader:** It does not read `.env` files. Secret loading is the responsibility of the host application.
- **Not a Crypto Abstraction DSL:** It exposes specific, approved primitives (AES-GCM, Argon2id, HKDF). It does not try to abstract "crypto" into a generic driver model.

## 6. Stability & Extraction Readiness

This module is **Production-Ready** and designed for extraction as a standalone library.

- **Frozen Components:** The `Password`, `KeyRotation`, `HKDF`, and `Reversible` modules are effectively frozen. Their interfaces and behaviors are locked.
- **Optional Components:** The `DX` layer is an optional convenience wrapper. Consumers can choose to wire the primitives manually if they require custom behavior.
