{% extends "layouts/base.twig" %}

{% block title %}Create Admin{% endblock %}

{% block content %}
    <div class="flex flex-wrap items-center justify-between gap-3">
        <h2 class="text-xl font-semibold text-gray-800">Create Admin</h2>

        <nav>
            <ol class="flex items-center gap-1.5">
                <li>
                    <a class="inline-flex items-center gap-1.5 text-sm text-gray-500" href="/dashboard">
                        Home
                        <svg class="stroke-current" width="17" height="16" viewBox="0 0 17 16" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M6.0765 12.667L10.2432 8.50033L6.0765 4.33366"
                                  stroke-width="1.2"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"/>
                        </svg>
                    </a>
                </li>
                <li>
                    <a class="inline-flex items-center gap-1.5 text-sm text-gray-500" href="/admins">
                        Admins
                        <svg class="stroke-current" width="17" height="16" viewBox="0 0 17 16" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M6.0765 12.667L10.2432 8.50033L6.0765 4.33366"
                                  stroke-width="1.2"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"/>
                        </svg>
                    </a>
                </li>
                <li class="text-sm text-gray-800">Create</li>
            </ol>
        </nav>
    </div>

    <div class="px-0 py-4 max-w-3xl">
        <div class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    New Admin Account
                </h3>

                <p class="text-sm text-gray-600 mb-6">
                    This action creates a new administrator account.
                    A temporary password will be generated by the system.
                </p>

                <form id="create-admin-form" class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="admin-email" class="block text-sm font-medium text-gray-700 mb-1">
                            Admin Email
                        </label>
                        <input
                                type="email"
                                id="admin-email"
                                required
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="admin@example.com"
                        >
                    </div>

                    <div class="flex items-center gap-3 mt-4">
                        <button
                                type="submit"
                                class="text-sm px-5 py-2 bg-blue-600 text-white rounded-md
                                   hover:bg-white hover:text-blue-600 border hover:border-blue-600
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Create Admin
                        </button>

                        <a href="/admins"
                           class="text-sm px-5 py-2 bg-white text-gray-600 border border-gray-300 rounded-md
                                  hover:bg-gray-100">
                            Cancel
                        </a>
                    </div>

                    <p id="create-admin-message" class="text-sm mt-4"></p>
                </form>
                <div id="create-admin-result"
                     class="hidden mt-6 p-4 border border-red-300 bg-red-50 rounded-md">
                    <h4 class="text-sm font-semibold text-red-700 mb-2">
                        ⚠️ Temporary Password (Shown Once)
                    </h4>

                    <p class="text-sm text-red-700 mb-3">
                        This password will <strong>not</strong> be shown again.
                        Make sure you store it securely before leaving this page.
                    </p>

                    <div class="text-sm mb-2">
                        <span class="font-medium text-gray-700">Admin ID:</span>
                        <span id="result-admin-id" class="font-mono text-gray-900"></span>
                    </div>

                    <div class="text-sm mb-4">
                        <span class="font-medium text-gray-700">Temporary Password:</span>
                        <code id="result-temp-password"
                              class="block mt-1 px-3 py-2 bg-white border rounded font-mono text-red-700 select-all"></code>
                    </div>

                    <a href="/admins"
                       class="inline-block mt-2 text-sm px-4 py-2 bg-red-600 text-white rounded-md
              hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        I have saved the password
                    </a>
                </div>

            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        (function () {
            const form = document.getElementById('create-admin-form');
            const emailInput = document.getElementById('admin-email');
            const messageBox = document.getElementById('create-admin-message');

            if (!form || !emailInput || !messageBox) {
                return;
            }

            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                messageBox.textContent = '';
                messageBox.className = 'text-sm mt-4';

                const email = emailInput.value.trim();
                if (!email) {
                    messageBox.textContent = 'Email is required.';
                    messageBox.classList.add('text-red-600');
                    return;
                }

                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.disabled = true;

                emailInput.disabled = true;

                try {
                    const response = await fetch('/api/admins/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json().catch(() => null);

                    // Scoped Step-Up required (safety net – normally already satisfied)
                    if (
                        response.status === 403 &&
                        data &&
                        data.code === 'STEP_UP_REQUIRED'
                    ) {
                        const scope = encodeURIComponent(data.scope || 'admin.create');
                        const returnTo = encodeURIComponent('/admins/create');
                        window.location.href =
                            `/2fa/verify?scope=${scope}&return_to=${returnTo}`;
                        return;
                    }

                    if (!response.ok) {
                        if (data && data.message) {
                            messageBox.textContent = data.message;
                        } else {
                            messageBox.textContent = 'Failed to create admin.';
                        }
                        messageBox.classList.add('text-red-600');

                        submitBtn.disabled = false;
                        emailInput.disabled = false;
                        return;
                    }

                    // Hide form
                    form.classList.add('hidden');

                    // Show result
                    const resultBox = document.getElementById('create-admin-result');
                    document.getElementById('result-admin-id').textContent = data.admin_id;
                    document.getElementById('result-temp-password').textContent = data.temp_password;

                    resultBox.classList.remove('hidden');

                    emailInput.value = '';

                } catch (err) {
                    messageBox.textContent = 'Network error. Please try again.';
                    messageBox.classList.add('text-red-600');

                    submitBtn.disabled = false;
                    emailInput.disabled = false;
                }
            });
        })();
    </script>
{% endblock %}
